---
title: "Phase II report figures"
author: "Jessica Guo"
date: "2/15/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Biomass and transpiration ts and diff figures

Create a panel of time-series and difference figures for the 3 environments comparison. Use same colors as in 03_metaanalysis_figures.Rmd for the time series, but new colors for the differences. 
```{r}
library(readxl)
library(udunits2)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(cowplot)
```

Data are in the data folder and include four files. 
```{r pressure, echo=FALSE}
loc <- "~/../../data/output/pecan_runs/env_comp_results/ch/pft/SetariaWT_ME034/"
# Prior distribution
load(paste0(loc, "prior.distns.Rdata"))
# Empirical data from BETYdb
load(paste0(loc, "jagged.data.Rdata"))
# Posterior samples
load(paste0(loc, "trait.mcmc.Rdata"))
# Match table
load(paste0(loc, "trt.match.Rdata"))

```

First, prepare model output and validation data for plotting 
```{r}
# Organize 3 treatments into same figure
treatments <- c("ch", "gh", "out")

biomass_ts <- c()
trans_ts <- c()
for (trt in treatments) {
  data_in <- read.csv(paste0("/data/output/pecan_runs/env_comp_results/", trt, 
                        "/ensemble_ts_summary_TotLivBiom.csv")) %>%
    mutate(treatment = trt,
           trait = "biomass") %>%
    relocate(treatment)
  biomass_ts <- rbind(biomass_ts, data_in)
  
  data_in <- read.csv(paste0("/data/output/pecan_runs/env_comp_results/", trt, 
                         "/ensemble_ts_summary_TVeg.csv")) %>%
    mutate(treatment = trt,
           trait = "transpiration") %>%
    relocate(treatment)
  trans_ts <- rbind(trans_ts, data_in)
}

# Bring in validation biomass
load("~/sentinel-detection/data/cleaned_data/biomass/chamber_biomass.Rdata")
load("~/sentinel-detection/data/cleaned_data/biomass/greenhouse_outdoor_biomass.Rdata")

biomass_valid_ch <- chamber_biomass %>%
  filter(genotype == "ME034V-1" &
           treatment %in% c(NA, "control") &
           temp == "31/22" &
           light == 430 &
           !is.na(stem_DW_mg) &
           !is.na(leaf_DW_mg) &
           !is.na(panicle_DW_mg)) %>%
  rename(plant_id = plantID) %>%
  mutate(location = "ch",
         stem_DW_g = ud.convert(stem_DW_mg, "mg", "g"),
         leaf_DW_g = ud.convert(leaf_DW_mg, "mg", "g"),
         panicle_DW_g = ud.convert(panicle_DW_mg, "mg", "g")) %>%
  dplyr::select(location, plant_id, sowing_date, transplant_date, harvest_date,
         stem_DW_g, leaf_DW_g, panicle_DW_g)

biomass_valid_gh_out <- greenhouse_outdoor_biomass %>%
  filter(genotype == "ME034V-1" &
           treatment %in% c("pot", "jolly_pot") &
           !is.na(stem_DW_g) &
           !is.na(leaf_DW_g) &
           !is.na(panicle_DW_g) & 
           exp_site == "GH" & exp_number == 1 |
           genotype == "ME034V-1" &
           treatment %in% c("pot", "jolly_pot") &
           !is.na(stem_DW_g) &
           !is.na(leaf_DW_g) &
           !is.na(panicle_DW_g) & 
           exp_site == "Field" & exp_number == 2) %>%
  mutate(location = case_when(exp_site == "GH" ~ "gh",
                              exp_site == "Field" ~ "out")) %>%
  dplyr::select(location, plant_id, sowing_date, transplant_date, harvest_date,
         stem_DW_g, leaf_DW_g, panicle_DW_g)

# Combine 2 kinds of validation data
biomass_valid <- rbind(biomass_valid_ch, biomass_valid_gh_out) %>%
  rename(treatment = location) %>%
  mutate(total_biomass_kg_m2 = ud.convert((stem_DW_g + leaf_DW_g + panicle_DW_g)/103,
                                          "g/cm2", "kg/m2"),
         day = difftime(harvest_date, sowing_date, units = "days"))

# Combine both Biomass and Transpiration time series
all_ts <- rbind.data.frame(biomass_ts, trans_ts)

```

Plot first set of time series panels. 
```{r}
cols <- brewer.pal(7, name = "Set1")

fig_biomass_ts <- ggplot() +
  geom_line(data = all_ts, aes(day, y = median, color = treatment)) +
  geom_ribbon(data = all_ts, aes(day, ymin = lcl_95, ymax = ucl_95, fill = treatment), 
              alpha = 0.25) +
  # geom_point(data = biomass_valid, aes(day, y = total_biomass_kg_m2, color = treatment)) +
  scale_x_continuous("Day of Experiment") + 
  # scale_y_continuous(expression(paste("Total Biomass (kg ",  m^-2, ")"))) +
  facet_wrap(~trait, ncol = 1, scales = "free_y") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y=element_blank(),
        strip.background = element_blank())

jpeg(filename = "../plots/biomass_ts.jpg", height = 5, width = 7, units = "in", res = 600)
print(fig_biomass_ts)
dev.off()


fig_temp <- ggplot() +
  stat_density(data = mcmc.temp, aes(x = value, color = treatment), 
               position = "identity", geom = "line") +
  geom_rug(data = jag.temp, aes(x = Y, color = treatment), 
           alpha = 0.5,
           length = unit(0.1, "npc")) +
  facet_wrap(~Trait, ncol = 3, scales = "free", labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        strip.background = element_blank(),
        legend.position = c(0.24, 0.9),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.key.size = unit(0.3, "cm"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  scale_color_manual(name = NULL, values = cols[c(7,1,2)])

fig_env <- ggplot() +
  stat_density(data = mcmc.env, aes(x = value, color = treatment),
             geom = "line",position = "identity") + 
  geom_rug(data = jag.env, aes(x = Y, color = treatment), 
           alpha = 0.5, 
           length = unit(0.1, "npc")) +
  facet_wrap(~Trait, ncol = 3, scales = "free", labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        strip.background = element_blank(),
        legend.position = c(0.24, 0.9),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.key.size = unit(0.3, "cm"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  scale_color_manual(name = NULL, values = cols[c(7,3,4,5)])

jpeg(filename = "plots/Fig1_parameters.jpg", height = 7, width = 7,
     units = "in", res = 600)
plot_grid(fig_temp, fig_env, ncol = 1, labels = c('a', 'b'))
dev.off()

```


